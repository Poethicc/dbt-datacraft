---
category: sub_main
step: 6_attribution
sub_step: 8_model
in_main_macro: attr
doc_status: ready
---
# macro `attr_model`

## ## Список используемых вспомогательных макросов

```dataview
TABLE 
category AS "Category", 
in_sub_main_macro AS "In Sub-Main Macro",
doc_status AS "Doc Status"
FROM "dbt Package"
WHERE file.name != "README" AND contains(in_sub_main_macro, "attr_model")
SORT doc_status
```
## Описание

Это восьмой шаг макроса `attr`.Этот макрос создает окончательную таблицу данных для атрибуции. Он объединяет различные модели атрибуции и присваивает им приоритеты.

## Аргументы

Этот макрос принимает следующие аргументы:
```sql
  params = none,
  funnel_name=none,
  limit0=none,
  metadata=project_metadata()
```
## Функциональность

Макрос обращается к `metadata`, и получает данные о воронках, моделях атрибуции, моделях

Далее происходит создание словаря для хранения информации о полях каждой модели. Каждая модель представлена как ключ, а ее поля как значения.

В макросе происходит настройка материализации данных: устанавливается порядок сортировки данных по идентификатору группы, номеру периода, дате, приоритету и идентификатору.

Далее происходят: 
- определение основных столбцов, необходимых для объединения данных моделей
- подсчёт числа целевых моделей (моделей с максимальным приоритетом) для каждой группы и периода
- выборка данных и расчет значений для каждой модели
- расчёт значений для последнего клика
- расчёт значений для первого клика

Если аргумент `limit0` активирован, то в конце SQL-запроса будет добавлено `LIMIT 0`.
## Пример

Файл в формате sql в папке models. Название файла `attr_myfirstfunnel_model`

Содержимое файла:
```sql
-- depends_on: {{ ref('attr_myfirstfunnel_join_to_attr_prepare_with_qid') }}

{{ etlcraft.attr() }}
```
